@page "/devices"
@using domain.Interfaces
@using application.Services
@inject DeviceManager DeviceManager
@inject NavigationManager Navigation
@inject ISnackbar Snackbar

<PageTitle>Devices</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudText Typo="Typo.h3">Devices</MudText>
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Outlined.Add"
                   OnClick="@ToggleCreateForm">
            @(_showCreateForm ? "Cancel" : "Add Device")
        </MudButton>
    </MudStack>

    @if (_showCreateForm)
    {
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Create New Device</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_newDeviceName"
                                      Label="Device Name"
                                      Required="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect @bind-Value="_newDeviceType"
                                   Label="Device Type"
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   T="string">
                            <MudSelectItem T="string" Value="@("Pdm")">PDM</MudSelectItem>
                            <MudSelectItem T="string" Value="@("PdmMax")">PDM-Max</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Canboard")">CANBoard</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_newDeviceBaseId"
                                         Label="Base ID"
                                         Required="true"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Max="2047"
                                         T="int" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton OnClick="@ToggleCreateForm">Cancel</MudButton>
                <MudButton Color="Color.Primary"
                           Variant="Variant.Outlined"
                           OnClick="@CreateDevice"
                           Disabled="@(string.IsNullOrWhiteSpace(_newDeviceName) || string.IsNullOrWhiteSpace(_newDeviceType))">
                    Create
                </MudButton>
            </MudCardActions>
        </MudCard>
    }

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!_devices.Any())
    {
        <MudAlert Severity="Severity.Info">
            No devices configured. Click "Add Device" to create one.
        </MudAlert>
    }
    else
    {
        <MudGrid>
            @foreach (var device in _devices)
            {
                <MudItem md="2">
                    <MudCard>
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@device.Name</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@(device.Connected ? Color.Success : Color.Error)">
                                    @(device.Connected ? "Connected" : "Disconnected")
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body1">
                                @device.Type
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Base ID: @device.BaseId
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Class="mx-2"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => NavigateToDevice(device.Guid))">
                                Monitor
                            </MudButton>
                            <MudButton Class="mx-2"
                                       Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteDevice(device))">
                                Delete
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private List<IDevice> _devices = [];
    private bool _loading = true;
    private bool _showCreateForm;

    // Form fields
    private string _newDeviceName = string.Empty;
    private string _newDeviceType = string.Empty;
    private int _newDeviceBaseId;

    protected override void OnInitialized()
    {
        LoadDevices();
    }

    private void LoadDevices()
    {
        _loading = true;
        try
        {
            _devices = DeviceManager.GetAllDevices().ToList();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error loading devices: {ex.Message}", Severity.Error);
            _devices = [];
        }
        finally
        {
            _loading = false;
        }
    }

    private void ToggleCreateForm()
    {
        _showCreateForm = !_showCreateForm;
        if (!_showCreateForm) return;
        
        // Reset form fields
        _newDeviceName = string.Empty;
        _newDeviceType = string.Empty;
        _newDeviceBaseId = 0;
    }

    private void CreateDevice()
    {
        try
        {
            DeviceManager.AddDevice(_newDeviceType, _newDeviceName, _newDeviceBaseId);

            Snackbar.Add($"Device '{_newDeviceName}' created successfully", Severity.Success);
            _showCreateForm = false;
            LoadDevices();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error creating device: {ex.Message}", Severity.Error);
        }
    }

    private void DeleteDevice(IDevice device)
    {
        try
        {
            DeviceManager.RemoveDevice(device.Guid);
            Snackbar.Add($"Device '{device.Name}' deleted successfully", Severity.Success);
            LoadDevices();
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error deleting device: {ex.Message}", Severity.Error);
        }
    }

    private void NavigateToDevice(Guid deviceId)
    {
        Navigation.NavigateTo($"/device/{deviceId}");
    }
}
