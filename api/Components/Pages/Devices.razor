@page "/devices"
@using api.Services
@using domain.Interfaces
@using application.Services
@inject DeviceManager DeviceManager
@inject NotificationService Notification
@inject IDialogService DialogService
@inject NavigationManager Navigation

<PageTitle>Devices</PageTitle>

<MudContainer MaxWidth="MaxWidth.ExtraLarge" Class="mt-4">
    <MudStack Row="true" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-4">
        <MudButton Variant="Variant.Outlined"
                   Color="Color.Primary"
                   StartIcon="@Icons.Material.Outlined.Add"
                   OnClick="@ToggleCreateForm">
            @(_showCreateForm ? "Cancel" : "Add Device")
        </MudButton>
    </MudStack>
    

    @if (_showCreateForm)
    {
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Create New Device</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_newDeviceName"
                                      Label="Device Name"
                                      Required="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudSelect @bind-Value="_newDeviceType"
                                   Label="Device Type"
                                   Required="true"
                                   Variant="Variant.Outlined"
                                   T="string">
                            <MudSelectItem T="string" Value="@("Pdm")">PDM</MudSelectItem>
                            <MudSelectItem T="string" Value="@("PdmMax")">PDM-Max</MudSelectItem>
                            <MudSelectItem T="string" Value="@("Canboard")">CANBoard</MudSelectItem>
                        </MudSelect>
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_newDeviceBaseId"
                                         Label="Base ID"
                                         Required="true"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Max="2047"
                                         T="int" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton OnClick="@ToggleCreateForm">Cancel</MudButton>
                <MudButton Color="Color.Primary"
                           Variant="Variant.Outlined"
                           OnClick="@CreateDevice"
                           Disabled="@(string.IsNullOrWhiteSpace(_newDeviceName) || string.IsNullOrWhiteSpace(_newDeviceType))">
                    Create
                </MudButton>
            </MudCardActions>
        </MudCard>
    }
    
    @if (_showModifyForm)
    {
        <MudCard Class="mb-4">
            <MudCardHeader>
                <CardHeaderContent>
                    <MudText Typo="Typo.h6">Modify Device</MudText>
                </CardHeaderContent>
            </MudCardHeader>
            <MudCardContent>
                <MudGrid>
                    <MudItem xs="12" sm="4">
                        <MudTextField @bind-Value="_newDeviceName"
                                      Label="Device Name"
                                      Required="true"
                                      Variant="Variant.Outlined" />
                    </MudItem>
                    <MudItem xs="12" sm="4">
                        <MudNumericField @bind-Value="_newDeviceBaseId"
                                         Label="Base ID"
                                         Required="true"
                                         Variant="Variant.Outlined"
                                         Min="0"
                                         Max="2047"
                                         T="int" />
                    </MudItem>
                </MudGrid>
            </MudCardContent>
            <MudCardActions>
                <MudButton OnClick="@CloseModifyForm">Cancel</MudButton>
                <MudButton Color="Color.Tertiary"
                           Variant="Variant.Outlined"
                           OnClick="@ModifyDevice"
                           Disabled="@(string.IsNullOrWhiteSpace(_newDeviceName) || string.IsNullOrWhiteSpace(_newDeviceType))">
                    Modify
                </MudButton>
            </MudCardActions>
        </MudCard>
    }

    @if (_loading)
    {
        <MudProgressCircular Indeterminate="true" />
    }
    else if (!_devices.Any())
    {
        <MudAlert Severity="Severity.Warning">
            No devices configured. Click "Add Device" to create one.
        </MudAlert>
    }
    else
    {
        <MudGrid Spacing="5">
            @foreach (var device in _devices)
            {
                <MudItem>
                    <MudCard Outlined="true">
                        <MudCardHeader>
                            <CardHeaderContent>
                                <MudText Typo="Typo.h6">@device.Name</MudText>
                            </CardHeaderContent>
                            <CardHeaderActions>
                                <MudChip T="string" Size="Size.Small" Variant="Variant.Outlined" Color="@(device.Connected ? Color.Success : Color.Error)">
                                    @(device.Connected ? "Connected" : "Disconnected")
                                </MudChip>
                            </CardHeaderActions>
                        </MudCardHeader>
                        <MudCardContent>
                            <MudText Typo="Typo.body1">
                                @device.Type
                            </MudText>
                            <MudText Typo="Typo.body2">
                                Base ID: @device.BaseId
                            </MudText>
                        </MudCardContent>
                        <MudCardActions>
                            <MudButton Class="mx-2"
                                       Variant="Variant.Outlined"
                                       Color="Color.Primary"
                                       Size="Size.Small"
                                       OnClick="@(() => NavigateToDevice(device.Guid))">
                                Open
                            </MudButton>
                            <MudButton Class="mx-2"
                                       Variant="Variant.Outlined"
                                       Color="Color.Info"
                                       Size="Size.Small"
                                       OnClick="@(() => ShowModifyForm(device))">
                                Modify
                            </MudButton>
                            <MudButton Class="mx-2"
                                       Variant="Variant.Outlined"
                                       Color="Color.Error"
                                       Size="Size.Small"
                                       OnClick="@(() => DeleteDevice(device))">
                                Delete
                            </MudButton>
                        </MudCardActions>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }
</MudContainer>

@code {
    private List<IDevice> _devices = [];
    private Timer? _refreshTimer;
    private bool _loading = true;
    private bool _showCreateForm;
    private bool _showModifyForm;

    // Form fields
    private string _newDeviceName = string.Empty;
    private string _newDeviceType = string.Empty;
    private int _newDeviceBaseId;

    private IDevice? _modifyDevice;

    protected override void OnInitialized()
    {
        LoadDevices();
        
        // Refresh at 20 Hz (every 50ms) to update UI with latest device state
        _refreshTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadDevices();
                StateHasChanged();
            });
        }, null, TimeSpan.FromMilliseconds(50), TimeSpan.FromMilliseconds(50));
    }

    private void LoadDevices()
    {
        _loading = true;
        try
        {
            _devices = DeviceManager.GetAllDevices().ToList();
        }
        catch (Exception ex)
        {
            Notification.NewError("Error loading devices",ex);
            _devices = [];
        }
        finally
        {
            _loading = false;
        }
    }

    private void ToggleCreateForm()
    {
        _showCreateForm = !_showCreateForm;
        if (!_showCreateForm) return;
        
        // Reset form fields
        _newDeviceName = string.Empty;
        _newDeviceType = string.Empty;
        _newDeviceBaseId = 2000;
    }

    private void ShowModifyForm(IDevice device)
    {
        _showModifyForm = true;

        _modifyDevice = device;
        
        _newDeviceName = device.Name;
        _newDeviceBaseId = device.BaseId;
        _newDeviceType = device.Type;
    }

    private void CloseModifyForm()
    {
        _showModifyForm = false;
    }

    private void CreateDevice()
    {
        try
        {
            DeviceManager.AddDevice(_newDeviceType, _newDeviceName, _newDeviceBaseId);

            Notification.NewSuccess($"Device '{_newDeviceName}' created successfully");
            _showCreateForm = false;
            LoadDevices();
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error creating device: {_newDeviceName}", ex);
        }
    }

    private void ModifyDevice()
    {
        try
        {
            if (_modifyDevice == null)
            {
                Notification.NewError($"Device '{_newDeviceName}' could not be modified");
                return;
            }

            DeviceManager.ModifyDeviceConfig(_modifyDevice.Guid, _newDeviceName, _newDeviceBaseId);

            Notification.NewSuccess($"Device '{_newDeviceName}' modify successfully sent.");
            Notification.NewWarning("Remember to Burn after modifying device base ID to store new ID on device");
            _showModifyForm = false;
            
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error modifying device {_newDeviceName}", ex);
        }
    }

    private async Task DeleteDevice(IDevice device)
    {
        var result = await DialogService.ShowMessageBox(
            $"Delete device?",
            $"Delete {device.Name}?",
            yesText: "Yes",
            cancelText: "Cancel");

        if (result != true)
            return;
        
        try
        {
            DeviceManager.RemoveDevice(device.Guid);
            Notification.NewSuccess($"Device '{device.Name}' deleted successfully");
            LoadDevices();
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error deleting device {device.Name}", ex);
        }
    }

    private void NavigateToDevice(Guid deviceId)
    {
        Navigation.NavigateTo($"/device/{deviceId}");
    }
    
    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
