@page "/system-log"
@using application.Services
@using application.Models
@inject SystemLogger Logger
@inject IDialogService DialogService
@rendermode InteractiveServer
@implements IDisposable

<PageTitle>System Log</PageTitle>

<MudContainer MaxWidth="MaxWidth.False" Style="padding: 16px;">
    <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center" Justify="Justify.SpaceBetween" Class="mb-3">
        <MudSelect @bind-Value="_levelFilter"
                   @bind-Value:after="LoadData"
                   Label="Level"
                   Dense="true"
                   Variant="Variant.Outlined"
                   Style="min-width: 50px;">
            <MudSelectItem Value="@((LogLevel?)null)">All</MudSelectItem>
            <MudSelectItem Value="@((LogLevel?)LogLevel.Debug)">Debug</MudSelectItem>
            <MudSelectItem Value="@((LogLevel?)LogLevel.Info)">Info</MudSelectItem>
            <MudSelectItem Value="@((LogLevel?)LogLevel.Warning)">Warning</MudSelectItem>
            <MudSelectItem Value="@((LogLevel?)LogLevel.Error)">Error</MudSelectItem>
        </MudSelect>

        <MudSelect @bind-Value="_sourceFilter"
                   @bind-Value:after="LoadData"
                   Label="Source"
                   Dense="true"
                   Variant="Variant.Outlined"
                   Style="min-width: 100px;">
            <MudSelectItem Value="@((string?)null)">All</MudSelectItem>
            @foreach (var source in _availableSources)
            {
                <MudSelectItem Value="@source">@source</MudSelectItem>
            }
        </MudSelect>
        
        <MudSpacer/>
        
        <MudDivider Vertical="true" FlexItem="true"/>
        
        <MudSwitch @bind-Value="@Logger.LogToFile"
                   @bind-Value:after="OnLogToFileChanged"
                   Color="Color.Primary"
                   Label="Log to File" />
        
        <MudCheckBox @bind-Value="_showDebug"
                     @bind-Value:after="LoadData"
                     Label="Show Debug"
                     Dense="true"/>
        
        <MudDivider Vertical="true" FlexItem="true"/>
        
        <MudButton Variant="Variant.Outlined" 
                   Color="Color.Error" 
                   OnClick="@ClearLogs" 
                   StartIcon="@Icons.Material.Filled.Delete">
            Clear
        </MudButton>
    </MudStack>

    @* Data Grid *@
    <MudDataGrid T="LogEntry"
                 Items="@_filteredLogs"
                 Dense="true"
                 Hover="true"
                 Striped="false"
                 FixedHeader="true"
                 Height="calc(100vh - 300px)"
                 Virtualize="true"
                 SortMode="SortMode.None">
        <Columns>
            <PropertyColumn Property="x => x.Timestamp" Title="Timestamp" Format="HH:mm:ss.fff" />
            <PropertyColumn Property="x => x.Level" Title="Level">
                <CellTemplate>
                    <MudChip Color="@GetLevelColor(context.Item.Level)" Size="Size.Small" Variant="Variant.Outlined">
                        @context.Item.Level
                    </MudChip>
                </CellTemplate>
            </PropertyColumn>
            <PropertyColumn Property="x => x.Source" Title="Source" />
            <PropertyColumn Property="x => x.Message" Title="Message" />
            <PropertyColumn Property="x => x.Exception" Title="Exception">
                <CellTemplate>
                    @if (!string.IsNullOrEmpty(context.Item.Exception))
                    {
                        <MudIconButton Icon="@Icons.Material.Filled.ErrorOutline"
                                       Size="Size.Small"
                                       Color="Color.Error"
                                       OnClick="@(() => ShowException(context.Item))" />
                    }
                </CellTemplate>
            </PropertyColumn>
        </Columns>
    </MudDataGrid>
</MudContainer>

@code {
    private List<LogEntry> _allLogs = [];
    private List<LogEntry> _filteredLogs = [];
    private List<string> _availableSources = [];
    private Timer? _refreshTimer;
    private LogLevel? _levelFilter;
    private string? _sourceFilter;
    private bool _showDebug;

    protected override void OnInitialized()
    {
        LoadData();

        // Auto-refresh at 10 Hz (100ms interval)
        _refreshTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromMilliseconds(100), TimeSpan.FromMilliseconds(100));
    }

    private void LoadData()
    {
        // Get all logs
        _allLogs = Logger.GetLogs(_levelFilter, _sourceFilter);

        // Apply debug filter
        if (!_showDebug)
        {
            _filteredLogs = _allLogs.Where(l => l.Level >= Logger.MinimumDisplayLevel).ToList();
        }
        else
        {
            _filteredLogs = _allLogs;
        }

        // Extract unique sources for dropdown
        _availableSources = _allLogs
            .Select(l => l.Source)
            .Distinct()
            .OrderBy(s => s)
            .ToList();
    }

    private void ClearLogs()
    {
        Logger.Clear();
        LoadData();
    }

    private void OnLogToFileChanged()
    {
        if (Logger.LogToFile)
        {
            Logger.CreateLogFile();
        }
    }

    private Color GetLevelColor(LogLevel level)
    {
        return level switch
        {
            LogLevel.Debug => Color.Secondary,
            LogLevel.Info => Color.Default,
            LogLevel.Warning => Color.Warning,
            LogLevel.Error => Color.Error,
            _ => Color.Default
        };
    }

    private async Task ShowException(LogEntry entry)
    {
        if (entry.Exception != null)
        {
            await DialogService.ShowMessageBox(
                entry.Source,
                entry.Exception);
        }
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
