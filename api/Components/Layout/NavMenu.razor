@using domain.Interfaces
@using application.Services
@inject DeviceManager DeviceManager
@inject NavigationManager Navigation
@rendermode InteractiveServer
@implements IDisposable

<MudNavMenu>
    <MudNavLink Href="" Match="NavLinkMatch.All" Icon="@Icons.Material.Filled.Home">
        Home
    </MudNavLink>

    <MudDivider Class="my-2" />

    <MudNavLink Href="devices" Icon="@Icons.Material.Filled.Devices">
        Devices
    </MudNavLink>

    @if (devices != null && devices.Any())
    {
        @foreach (var device in devices)
        {
            <MudNavLink Href="@($"device/{device.Guid}")"
                        Icon="@GetDeviceIcon(device.GetType().Name)"
                        IconColor="@(device.Connected ? Color.Success : Color.Default)"
                        Style="@($"padding-left: 32px; {(device.Connected ? "color: var(--mud-palette-success);" : "")}")">
                @device.Name
                @if (device.Connected)
                {
                    <MudIcon Icon="@Icons.Material.Filled.Circle"
                             Color="Color.Success"
                             Size="Size.Small"
                             Style="margin-left: auto;" />
                }
            </MudNavLink>
        }
    }
</MudNavMenu>

@code
{
    private List<IDevice> devices = new();
    private System.Threading.Timer? _refreshTimer;

    protected override void OnInitialized()
    {
        LoadDevices();

        // Refresh device list every second to catch new devices and connection status changes
        _refreshTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadDevices();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    private void LoadDevices()
    {
        try
        {
            devices = DeviceManager.GetAllDevices().ToList();
        }
        catch
        {
            // Silently fail - don't show errors in nav menu
            devices = new List<IDevice>();
        }
    }

    private string GetDeviceIcon(string deviceType)
    {
        return deviceType switch
        {
            "PdmDevice" => Icons.Material.Filled.PowerSettingsNew,
            "PdmMaxDevice" => Icons.Material.Filled.ElectricBolt,
            "CanboardDevice" => Icons.Material.Filled.DeveloperBoard,
            _ => Icons.Material.Filled.DeviceUnknown
        };
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
