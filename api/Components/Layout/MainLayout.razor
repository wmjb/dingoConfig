@using api.Services
@using domain.Interfaces
@using MudBlazor.Utilities
@inherits LayoutComponentBase
@implements IDisposable

@* Required *@
<MudThemeProvider IsDarkMode="true" Theme="_theme" />
<MudPopoverProvider />

@* Needed for dialogs *@
<MudDialogProvider />

@* Needed for snackbars *@
<MudSnackbarProvider />

<MudLayout>
    <MudAppBar Elevation="1">
        <MudIconButton Icon="@Icons.Material.Filled.Menu"
                       Color="Color.Inherit"
                       Edge="Edge.Start"
                       OnClick="@ToggleDrawer" />
        <MudText Typo="Typo.h5" Class="ml-3">dingoConfig</MudText>
        <MudDivider Vertical="true" FlexItem="true" Class="mx-3" />
        <FileToolbar OnNew="HandleNew"
                     OnOpen="HandleOpen"
                     OnSave="HandleSave"
                     OnSaveAs="HandleSaveAs" />
        <MudSpacer />
        @if (_showSimPlayback)
        {
            <SimPlaybackToolbar />
        }
        <AdapterToolbarControl />
        <MudIconButton Icon="@Icons.Material.Filled.Help"
                       Color="Color.Inherit"
                       Href="https://corygrant.github.io/dingoPDM/software/introduction/"
                       Target="_blank" />
    </MudAppBar>

    <MudDrawer @bind-Open="_drawerOpen" ClipMode="DrawerClipMode.Always" Elevation="2">
        <NavMenu />
    </MudDrawer>

    <MudMainContent>
        @Body
    </MudMainContent>
</MudLayout>

<div id="blazor-error-ui" data-nosnippet>
    An unhandled error has occurred.
    <a href="." class="reload">Reload</a>
    <span class="dismiss">🗙</span>
</div>

@code {
    [Inject] private application.Services.ConfigFileManager FileManager { get; set; } = null!;
    [Inject] private application.Services.DeviceManager DeviceManager { get; set; } = null!;
    [Inject] private NotificationService Notification { get; set; } = null!;
    [Inject] private ICommsAdapterManager AdapterManager { get; set; } = null!;

    private bool _drawerOpen = true;
    private bool _showSimPlayback;
    private Timer? _adapterStatusTimer;

    readonly MudTheme _theme = new MudTheme()
    {
        PaletteDark = new PaletteDark()
        {
            Primary = MudColor.Parse("#7FFF00"),
            Secondary = MudColor.Parse("#7FFF00"),
            Success = MudColor.Parse("#7FFF00"),
            Tertiary = MudColor.Parse("#00FFB3"),
            Info = MudColor.Parse("#00FFB3"),
        }
    };

    protected override void OnInitialized()
    {
        // Subscribe to adapter disconnection events
        AdapterManager.Disconnected += OnAdapterDisconnected;

        // Poll adapter status to show/hide SimPlaybackToolbar
        _adapterStatusTimer = new Timer(_ =>
        {
            InvokeAsync(() =>
            {
                var status = AdapterManager.GetStatus();
                _showSimPlayback = status is { isConnected: true, activeAdapter: "Sim" };
                StateHasChanged();
            });
        }, null, TimeSpan.FromMilliseconds(500), TimeSpan.FromMilliseconds(500));
    }

    private void ToggleDrawer()
    {
        _drawerOpen = !_drawerOpen;
    }

    private void OnAdapterDisconnected(object? sender, EventArgs e)
    {
        InvokeAsync(() =>
        {
            var status = AdapterManager.GetStatus();
            Notification.NewError($"Adapter disconnected: {status.activeAdapter ?? "Unknown"}");
            StateHasChanged();
        });
    }

    private async Task HandleNew()
    {
        DeviceManager.ClearDevices();
        FileManager.NewFile();
        Notification.NewInfo("New file created");
        await Task.CompletedTask;
    }

    private async Task HandleOpen(string fileName)
    {
        try
        {
            var devices = await FileManager.LoadDevices(fileName);
            if (devices is { Count: > 0 })
            {
                DeviceManager.ClearDevices();
                DeviceManager.AddDevices(devices);
                Notification.NewSuccess($"Opened {fileName} - {devices.Count} device(s) loaded");
                
                foreach(var device in devices)
                    Notification.NewSuccess($"Loaded device: {device.Name}, ID: {device.BaseId}");
            }
            else
            {
                Notification.NewWarning($"No devices found in {fileName}");
            }
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error opening file: {fileName}", ex);
        }
    }

    private async Task HandleSave()
    {
        try
        {
            var devices = DeviceManager.GetDevices();
            await FileManager.SaveDevices(devices);
            Notification.NewSuccess($"Saved {FileManager.CurrentFileName} - {devices.Count} device(s)");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error saving file: {FileManager.CurrentFileName}", ex);
        }
    }

    private async Task HandleSaveAs(string fileName)
    {
        try
        {
            var devices = DeviceManager.GetDevices();
            await FileManager.SaveDevices(devices, fileName);
            Notification.NewSuccess($"Saved as {fileName} - {devices.Count} device(s)");
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error saving file: {fileName}", ex);
        }
    }

    public void Dispose()
    {
        AdapterManager.Disconnected -= OnAdapterDisconnected;
        _adapterStatusTimer?.Dispose();
    }
}
