@using api.Services
@using api.Components.Dialogs
@using application.Services
@using domain.Interfaces
@using domain.Enums
@using Microsoft.AspNetCore.Components.Server.ProtectedBrowserStorage
@inject ICommsAdapterManager CommsAdapterManager
@inject NotificationService Notification
@inject SimPlayback SimPlayback
@inject IDialogService DialogService
@inject ProtectedLocalStorage ProtectedLocalStore
@rendermode InteractiveServer
@implements IDisposable

<MudBadge Color="Color.Warning"
          Dot="true"
          Overlap="true"
          Bordered="true"
          Visible="@(_available.Ports?.Length == 0)">
    <MudChip T="string"
             Icon="@Icons.Material.Filled.Cable"
             Color="@GetAdapterChipColor()"
             Variant="Variant.Outlined"
             Size="Size.Medium"
             OnClick="@((e) => TogglePopover(e))"
             Style="cursor: pointer;">
        @GetAdapterText()
    </MudChip>
</MudBadge>

<MudPopover Open="@_isOpen"
            AnchorOrigin="Origin.BottomRight"
            TransformOrigin="Origin.TopRight"
            OverflowBehavior="OverflowBehavior.FlipAlways">
    <MudPaper Class="pa-4" Style="min-width: 400px;" Elevation="8">
        @if (_loading)
        {
            <MudProgressCircular Indeterminate="true" Size="Size.Small" />
        }
        else
        {
            <MudText Typo="Typo.h6" Class="mb-3">
                <MudIcon Icon="@Icons.Material.Filled.Cable" Class="mr-2" />
                Adapter
            </MudText>

            @if (_status.IsConnected)
            {
                <!-- Connected State -->
                <MudAlert Severity="Severity.Success" Class="mb-3" Dense="true">
                    <strong>Connected</strong>
                </MudAlert>

                <MudText Typo="Typo.body2" Class="mb-1"><strong>Adapter:</strong> @_status.ActiveAdapter</MudText>
                <MudText Typo="Typo.body2" Class="mb-3"><strong>Port:</strong> @_status.ActivePort</MudText>

                <MudButton Variant="Variant.Filled"
                           Color="Color.Error"
                           StartIcon="@Icons.Material.Filled.LinkOff"
                           OnClick="@DisconnectAdapter"
                           Disabled="@_disconnecting"
                           FullWidth="true">
                    @(_disconnecting ? "Disconnecting..." : "Disconnect")
                </MudButton>
            }
            else
            {
                <!-- Disconnected State -->
                <MudAlert Severity="Severity.Warning" Class="mb-3" Dense="true">
                    <strong>Not Connected</strong>
                </MudAlert>

                <MudSelect @bind-Value="_selectedAdapterType"
                           Label="Adapter Type"
                           Variant="Variant.Outlined"
                           Dense="true"
                           Class="mb-2"
                           T="string">
                    @if (_available.Adapters != null)
                    {
                        @foreach (var adapter in _available.Adapters)
                        {
                            <MudSelectItem T="string" Value="@adapter">@adapter</MudSelectItem>
                        }
                    }
                </MudSelect>

                @* Show port selector for USB and SLCAN only (not PCAN or Sim) *@
                @if (!string.IsNullOrEmpty(_selectedAdapterType) && _selectedAdapterType != "Sim" && _selectedAdapterType != "PCAN")
                {
                    <MudSelect @bind-Value="_selectedPort"
                               Label="Port"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Class="mb-2"
                               T="string">
                        @if (_available.Ports != null)
                        {
                            @foreach (var port in _available.Ports)
                            {
                                <MudSelectItem T="string" Value="@port">@port</MudSelectItem>
                            }
                        }
                    </MudSelect>
                }

                @* Show bitrate selector for SLCAN and PCAN (not USB or Sim) *@
                @if (!string.IsNullOrEmpty(_selectedAdapterType) && _selectedAdapterType != "USB" && _selectedAdapterType != "Sim")
                {
                    <MudSelect @bind-Value="_selectedBitrate"
                               Label="Bitrate"
                               Variant="Variant.Outlined"
                               Dense="true"
                               Class="mb-3"
                               T="string">
                        <MudSelectItem T="string" Value="@("1000K")">1000K</MudSelectItem>
                        <MudSelectItem T="string" Value="@("500K")">500K</MudSelectItem>
                        <MudSelectItem T="string" Value="@("250K")">250K</MudSelectItem>
                        <MudSelectItem T="string" Value="@("125K")">125K</MudSelectItem>
                    </MudSelect>
                }
                else
                {
                    @* Add spacing if bitrate is hidden *@
                    <div class="mb-3"></div>
                }

                @if (_available.Adapters?.Length == 0 || _available.Ports?.Length == 0)
                {
                    <MudAlert Severity="Severity.Warning" Class="mb-3" Dense="true">
                        @if (_available.Adapters?.Length == 0)
                        {
                            <MudText Typo="Typo.caption">No adapters available</MudText>
                        }
                        @if (_available.Ports?.Length == 0)
                        {
                            <MudText Typo="Typo.caption">No ports detected</MudText>
                        }
                    </MudAlert>
                }

                @* Open Log File button for Sim adapter *@
                @if (_selectedAdapterType == "Sim")
                {
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Secondary"
                               StartIcon="@Icons.Material.Filled.FolderOpen"
                               OnClick="@OpenLogFile"
                               FullWidth="true"
                               Class="mb-3">
                        Open Log File
                    </MudButton>
                }

                <MudStack Row="true" Spacing="2">
                    <MudButton Variant="Variant.Outlined"
                               Color="Color.Primary"
                               StartIcon="@Icons.Material.Filled.Link"
                               OnClick="@ConnectAdapter"
                               Disabled="@(!CanConnect())"
                               FullWidth="true">
                        @(_connecting ? "Connecting..." : "Connect")
                    </MudButton>
                    <MudIconButton Icon="@Icons.Material.Filled.Refresh"
                                   OnClick="@RefreshAvailable"
                                   Color="Color.Default"
                                   Size="Size.Medium" />
                </MudStack>
            }
        }
    </MudPaper>
</MudPopover>

@code {
    private bool _isOpen;
    private (bool IsConnected, string? ActiveAdapter, string? ActivePort) _status;
    private (string[] Adapters, string[] Ports) _available;
    private bool _loading = true;
    private bool _connecting = false;
    private bool _disconnecting = false;
    private System.Threading.Timer? _refreshTimer;

    private string _selectedAdapterType = string.Empty;
    private string _selectedPort = string.Empty;
    private string _selectedBitrate = "500K";

    protected override void OnInitialized()
    {
        LoadData();

        // Refresh status every second
        _refreshTimer = new System.Threading.Timer(_ =>
        {
            InvokeAsync(() =>
            {
                LoadData();
                StateHasChanged();
            });
        }, null, TimeSpan.FromSeconds(1), TimeSpan.FromSeconds(1));
    }

    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            var result = await ProtectedLocalStore.GetAsync<string>("selectedAdapter");
            if (result.Success) _selectedAdapterType = result.Value;
            
            result = await ProtectedLocalStore.GetAsync<string>("selectedPort");
            if (result.Success) _selectedPort = result.Value;
            
            result = await ProtectedLocalStore.GetAsync<string>("selectedBitrate");
            if (result.Success) _selectedBitrate = result.Value;
        }
    }
    
    private void TogglePopover(MouseEventArgs e)
    {
        _isOpen = !_isOpen;
    }

    private void LoadData()
    {
        _loading = true;
        try
        {
            _status = CommsAdapterManager.GetStatus();
            _available = CommsAdapterManager.GetAvailable();

            if (!_status.IsConnected)
            {
                if (string.IsNullOrEmpty(_selectedAdapterType) && _available.Adapters?.Length > 0)
                {
                    _selectedAdapterType = _available.Adapters[0];
                }
                if (string.IsNullOrEmpty(_selectedPort) && _available.Ports?.Length > 0)
                {
                    _selectedPort = _available.Ports[0];
                }
            }
        }
        catch
        {
            // Silently fail
        }
        finally
        {
            _loading = false;
        }
    }

    private void RefreshAvailable()
    {
        try
        {
            _available = CommsAdapterManager.GetAvailable();
            Notification.NewInfo("Adapter list refreshed");
        }
        catch (Exception ex)
        {
            Notification.NewError("Error refreshing adapters", ex);
        }
    }

    private async Task ConnectAdapter()
    {
        _connecting = true;
        try
        {
            // Set port based on adapter type
            string port = _selectedAdapterType switch
            {
                "Sim" => "Simulated",
                "PCAN" => "PCAN_USBBUS1", // Default PCAN port
                _ => _selectedPort
            };

            // Set bitrate based on adapter type
            var bitrateString = _selectedAdapterType is "Sim" or "USB"
                ? "1000K"
                : _selectedBitrate;

            // Parse bitrate enum
            CanBitRate bitrate = bitrateString switch
            {
                "1000K" => CanBitRate.BitRate1000K,
                "500K" => CanBitRate.BitRate500K,
                "250K" => CanBitRate.BitRate250K,
                "125K" => CanBitRate.BitRate125K,
                _ => CanBitRate.BitRate500K
            };

            // Get adapter instance
            var adapter = CommsAdapterManager.ToAdapter(_selectedAdapterType);
            var success = await CommsAdapterManager.ConnectAsync(adapter, port, bitrate, CancellationToken.None);

            if (success)
            {
                Notification.NewSuccess($"Connected to {_selectedAdapterType}");
                LoadData();
                
                await ProtectedLocalStore.SetAsync("selectedAdapter", _selectedAdapterType);
                await ProtectedLocalStore.SetAsync("selectedPort", _selectedPort);
                await ProtectedLocalStore.SetAsync("selectedBitrate", _selectedBitrate);
                
                _isOpen = false; // Close popover on success
            }
            else
            {   
                Notification.NewError($"Failed to connect to {_selectedAdapterType}");
            }
        }
        catch (Exception ex)
        {
            Notification.NewError($"Error connecting: {_selectedAdapterType}", ex);
        }
        finally
        {
            _connecting = false;
        }
    }

    private async Task DisconnectAdapter()
    {
        _disconnecting = true;
        try
        {
            await CommsAdapterManager.DisconnectAsync();
            Notification.NewSuccess("Disconnected from adapter");
            LoadData();
            _isOpen = false; // Close popover on success
        }
        catch (Exception ex)
        {
            Notification.NewError("Error disconnecting", ex);
        }
        finally
        {
            _disconnecting = false;
        }
    }

    private bool CanConnect()
    {
        if (_connecting || string.IsNullOrWhiteSpace(_selectedAdapterType))
            return false;

        // Sim adapter doesn't need port or bitrate
        if (_selectedAdapterType == "Sim")
            return true;

        // USB adapter needs port but not bitrate
        if (_selectedAdapterType == "USB")
            return !string.IsNullOrWhiteSpace(_selectedPort);

        // PCAN needs bitrate but not port
        if (_selectedAdapterType == "PCAN")
            return !string.IsNullOrWhiteSpace(_selectedBitrate);

        // SLCAN needs both port and bitrate
        return !string.IsNullOrWhiteSpace(_selectedPort) && !string.IsNullOrWhiteSpace(_selectedBitrate);
    }

    private Color GetAdapterChipColor()
    {
        if (_status.IsConnected)
        {
            return Color.Success; // Green when connected
        }
        return Color.Default; // Gray when disconnected
    }

    private string GetAdapterText()
    {
        if (_status.IsConnected)
        {
            return $"Adapter: {_status.ActiveAdapter}";
        }
        return "Adapter: Disconnected";
    }

    private async Task OpenLogFile()
    {
        var parameters = new DialogParameters
        {
            { nameof(OpenFileDialog.FileFilter), "*.csv" }
        };

        var options = new DialogOptions
        {
            MaxWidth = MaxWidth.Medium,
            FullWidth = true
        };
        
        var dialog = await DialogService.ShowAsync<OpenFileDialog>("Open File", parameters, options);
        var dialogResult = await dialog.Result;
        
        if (dialogResult is { Canceled: false, Data: string fileName })
        {
            var (success, error) = await SimPlayback.LoadFile(fileName);
            if (success)
            {
                Notification.NewSuccess($"Loaded {System.IO.Path.GetFileName(fileName)}");
            }
            else
            {
                Notification.NewError($"Failed to load file: {error}");
            }
        }
        
    }

    public void Dispose()
    {
        _refreshTimer?.Dispose();
    }
}
