@using contracts.Devices.Pdm
@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@using application.Services
@using api.Components.Functions
@inject DeviceManager DeviceManager
@inject HttpClient Http
@inject ISnackbar Snackbar
@typeparam TDto where TDto : PdmDto
@typeparam TDevice where TDevice : PdmDevice

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h5">@DeviceName - @State.Name</MudText>
                <MudChip T="string" Color="@(State.Connected ? Color.Success : Color.Error)" Size="Size.Small">
                    @(State.Connected ? "Connected" : "Disconnected")
                </MudChip>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudText Typo="Typo.caption">GUID: @State.Guid</MudText>
        </CardHeaderActions>
    </MudCardHeader>

    @* Device Control Buttons *@
    <div class="pa-3">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Info"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Download"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnReadDeviceAsync">
                Read
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Primary"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Upload"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnWriteDeviceAsync">
                Write
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Warning"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Save"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnBurnSettingsAsync">
                Burn
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Info"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnRequestVersionAsync">
                Version
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Bedtime"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnSleepAsync">
                Sleep
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Success"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.WbSunny"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnWakeupAsync">
                Wakeup
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Error"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.DeveloperMode"
                       Disabled="@(!State.Connected)"
                       OnClick="@OnEnterBootloaderAsync">
                Bootloader
            </MudButton>
        </MudStack>
        <MudDivider Class="my-2" />
    </div>

    <MudCardContent>
        @* Device-level metrics *@
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.BatteryVoltage.ToString("F1") V</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Battery Voltage</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.TotalCurrent.ToString("F1") A</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Current</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.BoardTempC.ToString("F1") Â°C</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Board Temperature</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@State.State</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Device State</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        @* Outputs *@
        <MudText Typo="Typo.h6" Class="mb-2">Outputs</MudText>
        <MudGrid>
            @foreach (var (output, index) in State.Outputs.Select((o, i) => (o, i)))
            {
                <MudItem xs="6" md="3">
                    <MudCard Outlined="true" Class="pa-2">
                        <MudCardContent Class="pa-2">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1">Output @(index + 1)</MudText>
                                <MudChip T="string" Color="@GetOutputColor(output.State)" Size="Size.Small">
                                    @GetOutputStateText(output.State)
                                </MudChip>
                                <MudText Typo="Typo.body2">@output.Current.ToString("F1") A</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Digital Inputs *@
        @if (State.Inputs.Any())
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Digital Inputs</MudText>
            <MudStack Row="true" Spacing="2">
                @foreach (var (input, index) in State.Inputs.Select((i, idx) => (i, idx)))
                {
                    <MudChip T="string" Color="@(input.State ? Color.Success : Color.Default)" Size="Size.Small">
                        Input @(index + 1): @(input.State ? "ON" : "OFF")
                    </MudChip>
                }
            </MudStack>
        }

        @* Function Configurations *@
        @if (_device != null)
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h5" Class="mb-4">Configuration</MudText>

            <MudExpansionPanels MultiExpansion="true">
                @* Inputs *@
                @if (_device.Inputs.Any())
                {
                    <MudExpansionPanel Text="@($"Inputs ({_device.Inputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _inputsExpanded = expanded)">
                        @if (_inputsExpanded)
                        {
                            <InputsGrid Inputs="_device.Inputs"/>
                        }
                    </MudExpansionPanel>
                }

                @* Outputs *@
                @if (_device.Outputs.Any())
                {
                    <MudExpansionPanel Text="@($"Outputs ({_device.Outputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _outputsExpanded = expanded)">
                        @if (_outputsExpanded)
                        {
                            <OutputsGrid Outputs="_device.Outputs" />
                        }
                    </MudExpansionPanel>
                }

                @* CAN Inputs *@
                @if (_device.CanInputs.Any())
                {
                    <MudExpansionPanel Text="@($"CAN Inputs ({_device.CanInputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _canInputsExpanded = expanded)">
                        @if (_canInputsExpanded)
                        {
                            <CanInputsGrid CanInputs="_device.CanInputs" />
                        }
                    </MudExpansionPanel>
                }

                @* Virtual Inputs *@
                @if (_device.VirtualInputs.Any())
                {
                    <MudExpansionPanel Text="@($"Virtual Inputs ({_device.VirtualInputs.Count})")"
                                       ExpandedChanged="@((bool expanded) => _virtualInputsExpanded = expanded)">
                        @if (_virtualInputsExpanded)
                        {
                            <VirtualInputsGrid VirtualInputs="_device.VirtualInputs" />
                        }
                    </MudExpansionPanel>
                }

                @* Conditions *@
                @if (_device.Conditions.Any())
                {
                    <MudExpansionPanel Text="@($"Conditions ({_device.Conditions.Count})")"
                                       ExpandedChanged="@((bool expanded) => _conditionsExpanded = expanded)">
                        @if (_conditionsExpanded)
                        {
                            <ConditionsGrid Conditions="_device.Conditions" />
                        }
                    </MudExpansionPanel>
                }

                @* Counters *@
                @if (_device.Counters.Any())
                {
                    <MudExpansionPanel Text="@($"Counters ({_device.Counters.Count})")"
                                       ExpandedChanged="@((bool expanded) => _countersExpanded = expanded)">
                        @if (_countersExpanded)
                        {
                            <CountersGrid Counters="_device.Counters" />
                        }
                    </MudExpansionPanel>
                }

                @* Flashers *@
                @if (_device.Flashers.Any())
                {
                    <MudExpansionPanel Text="@($"Flashers ({_device.Flashers.Count})")"
                                       ExpandedChanged="@((bool expanded) => _flashersExpanded = expanded)">
                        @if (_flashersExpanded)
                        {
                            <FlashersGrid Flashers="_device.Flashers" />
                        }
                    </MudExpansionPanel>
                }

                @* Wiper *@
                <MudExpansionPanel Text="Wiper"
                                   ExpandedChanged="@((bool expanded) => _wiperExpanded = expanded)">
                    @if (_wiperExpanded)
                    {
                        <WiperConfig Wiper="_device.Wipers" />
                    }
                </MudExpansionPanel>

                @* Starter Disable *@
                <MudExpansionPanel Text="Starter Disable"
                                   ExpandedChanged="@((bool expanded) => _starterDisableExpanded = expanded)">
                    @if (_starterDisableExpanded)
                    {
                        <StarterDisableConfig StarterDisable="_device.StarterDisable" />
                    }
                </MudExpansionPanel>
            </MudExpansionPanels>
        }

    </MudCardContent>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public TDto State { get; set; } = null!;

    [Parameter, EditorRequired]
    public string DeviceName { get; set; } = null!;

    private TDevice? _device;

    // Expansion panel state tracking for lazy loading
    private bool _inputsExpanded = false;
    private bool _outputsExpanded = false;
    private bool _canInputsExpanded = false;
    private bool _virtualInputsExpanded = false;
    private bool _conditionsExpanded = false;
    private bool _countersExpanded = false;
    private bool _flashersExpanded = false;
    private bool _wiperExpanded = false;
    private bool _starterDisableExpanded = false;

    protected override void OnParametersSet()
    {
        // Get the actual device from DeviceManager to access function collections
        _device = DeviceManager.GetDevice<TDevice>(State.Guid);
    }

    private static Color GetOutputColor(OutState state) => state switch
    {
        OutState.On => Color.Success,
        OutState.Overcurrent => Color.Error,
        OutState.Fault => Color.Warning,
        _ => Color.Default      // Off
    };

    private static string GetOutputStateText(OutState state) => state switch
    {
        OutState.On => "ON",
        OutState.Overcurrent => "OVERCURRENT",
        OutState.Fault => "RESETTING",
        _ => "OFF"
    };

    // Helper method to get API route prefix based on device type
    private string GetApiRoutePrefix()
    {
        return State.DeviceType switch
        {
            "Pdm" => "api/pdm-device",
            "PdmMax" => "api/pdm-max-device",
            _ => throw new InvalidOperationException($"Unknown device type: {State.DeviceType}")
        };
    }

    // Device operation methods
    private async Task OnReadDeviceAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/read", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Device read initiated - configuration will be updated as responses arrive", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to read device: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading device: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnWriteDeviceAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/write", State);

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Device configuration write initiated", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to write device: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error writing device: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnBurnSettingsAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/burn", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Burn settings command sent to device", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to burn settings: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error burning settings: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnRequestVersionAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/version", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Version request sent to device", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to request version: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error requesting version: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnSleepAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/sleep", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Sleep command sent to device", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to send sleep command: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending sleep command: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnWakeupAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/wakeup", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Wakeup command sent to device", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to send wakeup command: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending wakeup command: {ex.Message}", Severity.Error);
        }
    }

    private async Task OnEnterBootloaderAsync()
    {
        try
        {
            var prefix = GetApiRoutePrefix();
            var response = await Http.PutAsJsonAsync($"{prefix}/{State.Guid}/bootloader", new { });

            if (response.IsSuccessStatusCode)
            {
                Snackbar.Add("Enter bootloader command sent to device", Severity.Success);
            }
            else
            {
                var error = await response.Content.ReadAsStringAsync();
                Snackbar.Add($"Failed to send bootloader command: {error}", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending bootloader command: {ex.Message}", Severity.Error);
        }
    }
}
