@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@using application.Services
@using api.Components.Functions
@inject DeviceManager DeviceManager
@inject ISnackbar Snackbar
@typeparam TDevice where TDevice : PdmDevice

<MudCard>
    <MudCardHeader>
        <CardHeaderContent>
            <MudStack Row="true" AlignItems="AlignItems.Center" Spacing="2">
                <MudText Typo="Typo.h5">@DeviceName - @Device.Name</MudText>
                <MudChip T="string" Variant="Variant.Outlined" Color="@(Device.Connected ? Color.Success : Color.Error)" Size="Size.Small">
                    @(Device.Connected ? "Connected" : "Disconnected")
                </MudChip>
            </MudStack>
        </CardHeaderContent>
        <CardHeaderActions>
            <MudText Typo="Typo.caption">GUID: @Device.Guid</MudText>
        </CardHeaderActions>
    </MudCardHeader>

    @* Device Control Buttons *@
    <div class="pa-3">
        <MudStack Row="true" Spacing="2" AlignItems="AlignItems.Center">
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Download"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnReadDeviceAsync">
                Read
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Upload"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnWriteDeviceAsync">
                Write
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Save"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnBurnSettingsAsync">
                Burn
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Info"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnRequestVersionAsync">
                Version
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.Bedtime"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnSleepAsync">
                Sleep
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.WbSunny"
                       Disabled="@(Device.Connected || !AdapterConnected)"
                       OnClick="@OnWakeupAsync">
                Wakeup
            </MudButton>
            <MudButton Variant="Variant.Outlined"
                       Color="Color.Default"
                       Size="Size.Small"
                       StartIcon="@Icons.Material.Filled.DeveloperMode"
                       Disabled="@(!Device.Connected || !AdapterConnected)"
                       OnClick="@OnEnterBootloaderAsync">
                Bootloader
            </MudButton>
        </MudStack>
        <MudDivider Class="my-2" />
    </div>

    <MudCardContent>
        @* Device-level metrics *@
        <MudGrid>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@Device.BatteryVoltage.ToString("F1") V</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Battery Voltage</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@Device.TotalCurrent.ToString("F1") A</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Total Current</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@Device.BoardTempC.ToString("F1") Â°C</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Board Temperature</MudText>
            </MudItem>
            <MudItem xs="12" md="3">
                <MudText Typo="Typo.h6">@Device.DeviceState</MudText>
                <MudText Typo="Typo.body2" Color="Color.Secondary">Device State</MudText>
            </MudItem>
        </MudGrid>

        <MudDivider Class="my-4" />

        @* Outputs *@
        <MudText Typo="Typo.h6" Class="mb-2">Outputs</MudText>
        <MudGrid>
            @foreach (var (output, index) in Device.GetOutputs().Select((o, i) => (o, i)))
            {
                <MudItem xs="6" md="3">
                    <MudCard Outlined="true" Class="pa-2">
                        <MudCardContent Class="pa-2">
                            <MudStack Spacing="1">
                                <MudText Typo="Typo.body1">@output.Name</MudText>
                                <MudChip T="string"  Variant="Variant.Outlined" Color="@GetOutputColor(output.State)" Size="Size.Small">
                                    @GetOutputStateText(output.State)
                                </MudChip>
                                <MudText Typo="Typo.body2">@output.Current.ToString("F1") A</MudText>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>

        @* Digital Inputs *@
        @if (Device.GetInputs().Any())
        {
            <MudDivider Class="my-4" />
            <MudText Typo="Typo.h6" Class="mb-2">Digital Inputs</MudText>
            <MudStack Row="true" Spacing="2">
                @foreach (var (input, index) in Device.GetInputs().Select((i, idx) => (i, idx)))
                {
                    <MudChip T="string" Variant="Variant.Outlined" Color="@(input.State ? Color.Success : Color.Default)" Size="Size.Small">
                        Input @(index + 1): @(input.State ? "ON" : "OFF")
                    </MudChip>
                }
            </MudStack>
        }

        @* Function Configurations *@
        <MudDivider Class="my-4" />
        <MudText Typo="Typo.h5" Class="mb-4">Configuration</MudText>

        <MudExpansionPanels MultiExpansion="true">
            @* Inputs *@
            @if (Device.Inputs.Any())
            {
                <MudExpansionPanel Text="@($"Inputs ({Device.Inputs.Count})")"
                                   ExpandedChanged="@((bool expanded) => _inputsExpanded = expanded)">
                    @if (_inputsExpanded)
                    {
                        <InputsGrid Inputs="Device.Inputs"/>
                    }
                </MudExpansionPanel>
            }

            @* Outputs *@
            @if (Device.Outputs.Any())
            {
                <MudExpansionPanel Text="@($"Outputs ({Device.Outputs.Count})")"
                                   ExpandedChanged="@((bool expanded) => _outputsExpanded = expanded)">
                    @if (_outputsExpanded)
                    {
                        <OutputsGrid Outputs="Device.Outputs" />
                    }
                </MudExpansionPanel>
            }

            @* Outputs PWM *@
            @if (Device.Outputs.Any())
            {
                <MudExpansionPanel Text="@($"Outputs PWM ({Device.Outputs.Count})")"
                                   ExpandedChanged="@((bool expanded) => _outputsPwmExpanded = expanded)">
                    @if (_outputsPwmExpanded)
                    {
                        <OutputsPwmGrid Outputs="Device.Outputs" />
                    }
                </MudExpansionPanel>
            }
            @* CAN Inputs *@
            @if (Device.CanInputs.Any())
            {
                <MudExpansionPanel Text="@($"CAN Inputs ({Device.CanInputs.Count})")"
                                   ExpandedChanged="@((bool expanded) => _canInputsExpanded = expanded)">
                    @if (_canInputsExpanded)
                    {
                        <CanInputsGrid CanInputs="Device.CanInputs" />
                        @*
                        <MudGrid>
                            @foreach (var canInput in Device.GetCanInputs())
                            {
                                <MudItem md="2">
                                    <CanInputCard Item="canInput"
                                                  DeviceId="@Device.Guid"/>
                                </MudItem>
                            }
                        </MudGrid>
                        *@
                    }
                </MudExpansionPanel>
            }

            @* Virtual Inputs *@
            @if (Device.VirtualInputs.Any())
            {
                <MudExpansionPanel Text="@($"Virtual Inputs ({Device.VirtualInputs.Count})")"
                                   ExpandedChanged="@((bool expanded) => _virtualInputsExpanded = expanded)">
                    @if (_virtualInputsExpanded)
                    {
                        <VirtualInputsGrid VirtualInputs="Device.VirtualInputs" />
                    }
                </MudExpansionPanel>
            }

            @* Conditions *@
            @if (Device.Conditions.Any())
            {
                <MudExpansionPanel Text="@($"Conditions ({Device.Conditions.Count})")"
                                   ExpandedChanged="@((bool expanded) => _conditionsExpanded = expanded)">
                    @if (_conditionsExpanded)
                    {
                        <ConditionsGrid Conditions="Device.Conditions" />
                    }
                </MudExpansionPanel>
            }

            @* Counters *@
            @if (Device.Counters.Any())
            {
                <MudExpansionPanel Text="@($"Counters ({Device.Counters.Count})")"
                                   ExpandedChanged="@((bool expanded) => _countersExpanded = expanded)">
                    @if (_countersExpanded)
                    {
                        <CountersGrid Counters="Device.Counters" />
                    }
                </MudExpansionPanel>
            }

            @* Flashers *@
            @if (Device.Flashers.Any())
            {
                <MudExpansionPanel Text="@($"Flashers ({Device.Flashers.Count})")"
                                   ExpandedChanged="@((bool expanded) => _flashersExpanded = expanded)">
                    @if (_flashersExpanded)
                    {
                        <FlashersGrid Flashers="Device.Flashers" />
                    }
                </MudExpansionPanel>
            }

            @* Wiper *@
            <MudExpansionPanel Text="Wiper"
                               ExpandedChanged="@((bool expanded) => _wiperExpanded = expanded)">
                @if (_wiperExpanded)
                {
                    <WiperConfig Wiper="Device.Wipers" />
                }
            </MudExpansionPanel>

            @* Starter Disable *@
            <MudExpansionPanel Text="Starter Disable"
                               ExpandedChanged="@((bool expanded) => _starterDisableExpanded = expanded)">
                @if (_starterDisableExpanded)
                {
                    <StarterDisableConfig StarterDisable="Device.StarterDisable" />
                }
            </MudExpansionPanel>
        </MudExpansionPanels>

    </MudCardContent>
</MudCard>

@code {
    [Parameter, EditorRequired]
    public TDevice Device { get; set; } = null!;

    [Parameter, EditorRequired]
    public string DeviceName { get; set; } = null!;
    
    [Parameter, EditorRequired]
    public bool AdapterConnected { get; set; }

    // Expansion panel state tracking for lazy loading
    private bool _inputsExpanded = false;
    private bool _outputsExpanded = false;
    private bool _outputsPwmExpanded = false;
    private bool _canInputsExpanded = false;
    private bool _virtualInputsExpanded = false;
    private bool _conditionsExpanded = false;
    private bool _countersExpanded = false;
    private bool _flashersExpanded = false;
    private bool _wiperExpanded = false;
    private bool _starterDisableExpanded = false;

    private static Color GetOutputColor(OutState state) => state switch
    {
        OutState.On => Color.Success,
        OutState.Overcurrent => Color.Error,
        OutState.Fault => Color.Warning,
        _ => Color.Default      // Off
    };

    private static string GetOutputStateText(OutState state) => state switch
    {
        OutState.On => "ON",
        OutState.Overcurrent => "OVERCURRENT",
        OutState.Fault => "RESETTING",
        _ => "OFF"
    };

    // Device operation methods - Direct service calls (no HTTP)
    private void OnReadDeviceAsync()
    {
        try
        {
            DeviceManager.ReadDeviceConfig(Device.Guid);
            Snackbar.Add("Device read initiated - configuration will be updated as responses arrive", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error reading device: {ex.Message}", Severity.Error);
        }
    }

    private void OnWriteDeviceAsync()
    {
        try
        {
            DeviceManager.WriteDeviceConfig(Device.Guid);
            Snackbar.Add("Device configuration write initiated", Severity.Success);
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error writing device: {ex.Message}", Severity.Error);
        }
    }

    private void OnBurnSettingsAsync()
    {
        try
        {
            if (DeviceManager.BurnSettings(Device.Guid))
            {
                Snackbar.Add("Burn settings command sent to device", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to burn settings", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error burning settings: {ex.Message}", Severity.Error);
        }
    }

    private void OnRequestVersionAsync()
    {
        try
        {
            if (DeviceManager.RequestVersion(Device.Guid))
            {
                Snackbar.Add("Version request sent to device", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to request version", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error requesting version: {ex.Message}", Severity.Error);
        }
    }

    private void OnSleepAsync()
    {
        try
        {
            if (DeviceManager.RequestSleep(Device.Guid))
            {
                Snackbar.Add("Sleep command sent to device", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send sleep command", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending sleep command: {ex.Message}", Severity.Error);
        }
    }

    private void OnWakeupAsync()
    {
        try
        {
            if (DeviceManager.RequestWakeup(Device.Guid))
            {
                Snackbar.Add("Wakeup command sent to device", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send wakeup command", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending wakeup command: {ex.Message}", Severity.Error);
        }
    }

    private void OnEnterBootloaderAsync()
    {
        try
        {
            if (DeviceManager.RequestBootloader(Device.Guid))
            {
                Snackbar.Add("Enter bootloader command sent to device", Severity.Success);
            }
            else
            {
                Snackbar.Add("Failed to send bootloader command", Severity.Error);
            }
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error sending bootloader command: {ex.Message}", Severity.Error);
        }
    }
}
