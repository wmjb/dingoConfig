@using domain.Devices.dingoPdm.Functions
@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@using application.Services

<MudDialog>
    <DialogContent>
        <EditForm Model="@_editModel" OnValidSubmit="HandleValidSubmit">
            <DataAnnotationsValidator/>
            <MudSwitch @bind-Value="_editModel.Enabled"
                       Label="Enabled"
                       Color="Color.Primary"/>
            <MudTextField @bind-Value="_editModel.Name"
                          Label="Name"
                          Variant="Variant.Outlined"
                          For="@(() => _editModel.Name)"
                          Class="mt-3"/>
            <MudNumericField @bind-Value="_editModel.Id"
                             Label="Id"
                             Variant="Variant.Outlined"
                             For="@(() => _editModel.Id)"
                             Class="mt-3"/>
            <MudSelect @bind-Value="_editModel.Operator"
                       Label="Operator"
                       Variant="Variant.Outlined"
                       For="@(() => _editModel.Operator)"
                       Class="mt-3">
                <MudSelectItem Value="@Operator.Equal">=</MudSelectItem>
                <MudSelectItem Value="@Operator.NotEqual">!=</MudSelectItem>
                <MudSelectItem Value="@Operator.GreaterThan">&gt;</MudSelectItem>
                <MudSelectItem Value="@Operator.LessThan">&lt;</MudSelectItem>
                <MudSelectItem Value="@Operator.GreaterThanOrEqual">&gt;=</MudSelectItem>
                <MudSelectItem Value="@Operator.LessThanOrEqual">&lt;=</MudSelectItem>
                <MudSelectItem Value="@Operator.BitwiseAnd">&</MudSelectItem>
                <MudSelectItem Value="@Operator.BitwiseNand">!&</MudSelectItem>
            </MudSelect>

            <ValidationSummary/>
        </EditForm>
        </DialogContent>
    <DialogActions>

        <MudButton OnClick="@Cancel">Cancel</MudButton>
        <MudButton Color="Color.Primary"
                   Variant="Variant.Filled"
                   OnClick="@Save">
            Save
        </MudButton>
    </DialogActions>
</MudDialog>
@code {
    [CascadingParameter]
    IMudDialogInstance MudDialog { get; set; } = null!;

    [Parameter, EditorRequired]
    public CanInput Model { get; set; } = null!;

    [Parameter, EditorRequired]
    public Guid DeviceId { get; set; }

    [Inject]
    private DeviceManager DeviceManager { get; set; } = null!;

    [Inject]
    private ISnackbar Snackbar { get; set; } = null!;

    private CanInput _editModel = null!;

    protected override void OnParametersSet()
    {
        // Create a working copy for editing
        _editModel = new CanInput(Model.Number, Model.Name)
        {
            Enabled = Model.Enabled,
            TimeoutEnabled = Model.TimeoutEnabled,
            Timeout = Model.Timeout,
            Ide = Model.Ide,
            StartingByte = Model.StartingByte,
            Dlc = Model.Dlc,
            Operator = Model.Operator,
            OnVal = Model.OnVal,
            Mode = Model.Mode,
            Id = Model.Id
        };
    }

    private void Cancel()
    {
        MudDialog.Cancel();
    }

    private void Save()
    {
        try
        {
            // Update the domain model directly with edited values
            Model.Enabled = _editModel.Enabled;
            Model.Name = _editModel.Name;
            Model.TimeoutEnabled = _editModel.TimeoutEnabled;
            Model.Timeout = _editModel.Timeout;
            Model.Ide = _editModel.Ide;
            Model.StartingByte = _editModel.StartingByte;
            Model.Dlc = _editModel.Dlc;
            Model.Operator = _editModel.Operator;
            Model.OnVal = _editModel.OnVal;
            Model.Mode = _editModel.Mode;
            Model.Id = _editModel.Id;

            Snackbar.Add($"CAN Input {Model.Number} updated", Severity.Success);
            MudDialog.Close(DialogResult.Ok(true));
        }
        catch (Exception ex)
        {
            Snackbar.Add($"Error saving: {ex.Message}", Severity.Error);
        }
    }

    private void HandleValidSubmit()
    {
        Save();
    }
}