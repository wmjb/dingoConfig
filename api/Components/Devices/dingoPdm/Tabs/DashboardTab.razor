@using domain.Devices.dingoPdm.Enums
@using domain.Devices.dingoPdm
@typeparam TDevice where TDevice : PdmDevice

<div style="overflow-y: auto; height: calc(100vh - 250px); padding: 24px; scrollbar-width: auto; scrollbar-color: #888 transparent;">
    <MudText Typo="Typo.h6" Class="mb-2">Device</MudText>
    <MudGrid>
        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@Device.BatteryVoltage.ToString("F1") V</MudText>
                    <MudText Typo="Typo.body2">Battery Voltage</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@Device.TotalCurrent.ToString("F1") A</MudText>
                    <MudText Typo="Typo.body2">Total Current</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@Device.BoardTempC.ToString("F1") Â°C</MudText>
                    <MudText Typo="Typo.body2">Board Temperature</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>
        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@Device.DeviceState</MudText>
                    <MudText Typo="Typo.body2">Device State</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@Device.Version</MudText>
                    <MudText Typo="Typo.body2">FW Version</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent>
                    <MudText Typo="Typo.h6">@GetBitRateDisplay(Device.BitRate)</MudText>
                    <MudText Typo="Typo.body2">Bitrate</MudText>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent Style="align-content: center">
                    <MudChip T="string" Variant="Variant.Outlined"
                             Color="@(Device.SleepEnabled ? Color.Success : Color.Default)"
                             Size="Size.Small" Style="min-width: 100px;">
                        Sleep Enabled
                    </MudChip>
                </MudCardContent>
            </MudCard>
        </MudItem>

        <MudItem>
            <MudCard Style="height: 100%">
                <MudCardContent Style="align-content: center">
                    <MudChip T="string" Variant="Variant.Outlined"
                             Color="@(Device.CanFiltersEnabled ? Color.Success : Color.Default)"
                             Size="Size.Small" Style="min-width: 100px;">
                        CAN Filters
                    </MudChip>
                </MudCardContent>
            </MudCard>
        </MudItem>

    </MudGrid>

    <MudDivider Class="my-4"/>

    @* Outputs *@
    <MudText Typo="Typo.h6" Class="mb-2">Outputs</MudText>
    <MudGrid Spacing="2">
        @foreach (var (output, _) in Device.GetOutputs().Select((o, i) => (o, i)))
        {
            <MudItem>
                <MudCard Class="@(output.Enabled ? "" : "card-disabled")">
                    <MudCardContent>
                        <MudStack AlignItems="AlignItems.Center" Spacing="1">
                            <MudText Typo="Typo.body1">@output.Name</MudText>
                            <MudChip T="string" Variant="Variant.Outlined"
                                     Color="@GetOutputColor(output.State)"
                                     Size="Size.Small" Style="min-width: 100px;">
                                @GetOutputStateText(output.State)
                            </MudChip>
                            <MudText Typo="Typo.body2">@output.Current.ToString("F1") A</MudText>
                            <MudText Typo="Typo.body2">Reset Count: @output.ResetCount.ToString("D")</MudText>
                            @if (output.PwmEnabled)
                            {
                                <MudText Typo="Typo.body2">@output.CurrentDutyCycle.ToString("F1") %</MudText>
                                <MudText Typo="Typo.body2">@output.CalculatedCurrent.ToString("F1") A (Calculated)</MudText>
                            }
                        </MudStack>
                    </MudCardContent>
                </MudCard>
            </MudItem>
        }
    </MudGrid>

    @* Digital Inputs *@
    @if (Device.GetInputs().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">Digital Inputs</MudText>
        <MudGrid Spacing="2">
            @foreach (var (input, _) in Device.GetInputs().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(input.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@input.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(input.State ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @(input.State ? "ON" : "OFF")
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* CAN Inputs *@
    @if (Device.GetCanInputs().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">CAN Inputs</MudText>
        <MudGrid Spacing="2">
            @foreach (var (input, _) in Device.GetCanInputs().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(input.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@input.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(input.Output ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @input.Value
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Virtual Inputs *@
    @if (Device.GetVirtualInputs().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">Virtual Inputs</MudText>
        <MudGrid Spacing="2">
            @foreach (var (input, _) in Device.GetVirtualInputs().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(input.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@input.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(input.Value ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @(input.Value ? "ON" : "OFF")
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Condition *@
    @if (Device.GetConditions().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">Conditions</MudText>
        <MudGrid Spacing="2">
            @foreach (var (condition, _) in Device.GetConditions().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(condition.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@condition.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(condition.Value > 0 ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @condition.Value
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Counter *@
    @if (Device.GetCounters().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">Conditions</MudText>
        <MudGrid Spacing="2">
            @foreach (var (counter, _) in Device.GetCounters().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(counter.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@counter.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(counter.Value > 0 ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @counter.Value
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Flasher *@
    @if (Device.GetFlashers().Any())
    {
        <MudDivider Class="my-4"/>
        <MudText Typo="Typo.h6" Class="mb-2">Flashers</MudText>
        <MudGrid Spacing="2">
            @foreach (var (flasher, _) in Device.GetFlashers().Select((i, idx) => (i, idx)))
            {
                <MudItem>
                    <MudCard Class="@(flasher.Enabled ? "" : "card-disabled")">
                        <MudCardContent>
                            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                                <MudText Typo="Typo.body1">@flasher.Name</MudText>
                                <MudChip T="string" Variant="Variant.Outlined"
                                         Color="@(flasher.Value ? Color.Success : Color.Default)"
                                         Size="Size.Small" Style="min-width: 100px;">
                                    @(flasher.Value ? "ON" : "OFF")
                                </MudChip>
                            </MudStack>
                        </MudCardContent>
                    </MudCard>
                </MudItem>
            }
        </MudGrid>
    }

    @* Wiper *@
    <MudDivider Class="my-4"/>
    <MudText Typo="Typo.h6" Class="mb-2">Wiper</MudText>
    <MudCard Class="@(Device.Wipers.Enabled ? "" : "card-disabled")" Style="max-width: 200px">
        <MudCardContent>
            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body1">@Device.Wipers.Name</MudText>
                <MudChip T="string" Variant="Variant.Outlined"
                         Color="@(Device.Wipers.SlowState ? Color.Success : Color.Default)"
                         Size="Size.Small" Style="min-width: 100px;">
                    Slow
                </MudChip>
                <MudChip T="string" Variant="Variant.Outlined"
                         Color="@(Device.Wipers.FastState ? Color.Success : Color.Default)"
                         Size="Size.Small" Style="min-width: 100px;">
                    Fast
                </MudChip>
                <MudText Typo="Typo.body2">Mode: @Device.Wipers.Mode.ToString()</MudText>
            </MudStack>
        </MudCardContent>
    </MudCard>

    @* Starter Disable *@
    <MudDivider Class="my-4"/>
    <MudText Typo="Typo.h6" Class="mb-2">Starter Disable</MudText>
    <MudCard Class="@(Device.StarterDisable.Enabled ? "" : "card-disabled")" Style="max-width: 200px">
        <MudCardContent>
            <MudStack AlignItems="AlignItems.Center" Spacing="1">
                <MudText Typo="Typo.body1">@Device.StarterDisable.Name</MudText>
                @for (var i = 0; i < Device.StarterDisable.OutputsDisabled.Count; i++)
                {
                    <MudChip T="bool"
                             Color="@(Device.StarterDisable.OutputsDisabled[i] ? Color.Success : Color.Default)"
                             Text="@($"Output {i + 1}")"
                             Size="Size.Small"
                             Variant="Variant.Outlined"/>
                }
            </MudStack>
        </MudCardContent>
    </MudCard>
</div>

@code {
    [Parameter, EditorRequired] public TDevice Device { get; set; } = null!;

    private static Color GetOutputColor(OutState state) => state switch
    {
        OutState.On => Color.Success,
        OutState.Overcurrent => Color.Warning,
        OutState.Fault => Color.Error,
        _ => Color.Default // Off
    };

    private static string GetOutputStateText(OutState state) => state switch
    {
        OutState.On => "ON",
        OutState.Overcurrent => "OVERCURRENT",
        OutState.Fault => "RESETTING",
        _ => "OFF"
    };

    private string GetBitRateDisplay(domain.Enums.CanBitRate bitRate) => bitRate switch
    {
        domain.Enums.CanBitRate.BitRate1000K => "1000K",
        domain.Enums.CanBitRate.BitRate500K => "500K",
        domain.Enums.CanBitRate.BitRate250K => "250K",
        domain.Enums.CanBitRate.BitRate125K => "125K",
        _ => "Unknown"
    };
}
