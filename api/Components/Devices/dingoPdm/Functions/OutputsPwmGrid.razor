@using domain.Devices.dingoPdm.Functions
@using domain.Devices.dingoPdm.Enums

<MudDataGrid Items="@Outputs" Dense="true" Hover="true" Striped="false" EditMode="DataGridEditMode.Cell" ReadOnly="false" 
             SortMode="SortMode.None" ColumnResizeMode="ResizeMode.Container" Virtualize="true" 
             FixedHeader="true" HorizontalScrollbar="true" Style="max-height: 400px;">
    <Columns>
        <PropertyColumn Property="x => x.Number" Title="#" StickyLeft="true" Editable="false" CellStyle="max-width: 100px"/>
        <PropertyColumn Property="x => x.PwmEnabled" Title="Enabled" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudCheckBox @bind-Value="context.Item.PwmEnabled" Dense="true" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.Name" CellStyle="max-width: 200px">
            <EditTemplate>
                <MudTextField @bind-Value="context.Item.Name" Variant="Variant.Outlined" Margin="Margin.Dense" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.CurrentDutyCycle" Title="Duty Cycle" Editable="false" CellStyle="max-width: 100px">
            <CellTemplate>
                <MudChip T="string"
                         Variant="Variant.Outlined"
                         Color="@(context.Item.CurrentDutyCycle > 0.0 ? Color.Success : Color.Default)"
                         Size="Size.Small" Style="min-width: 50px;">
                    @context.Item.CurrentDutyCycle
                </MudChip>
            </CellTemplate>
        </PropertyColumn>
        <TemplateColumn Title="Freq (Hz)" Resizable="true" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudNumericField @bind-Value="@context.Item.Frequency" 
                                 Min="0"
                                 Max="511"
                                 Step="1"/>
            </EditTemplate>
        </TemplateColumn>
        <TemplateColumn Title="Fixed DC (%)" Resizable="true" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudNumericField Value="@context.Item.FixedDutyCycle" 
                                 ValueChanged="@((int val) => OnDutyCycleChanged(context.Item, val))"/>
            </EditTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.VariableDutyCycle" Title="Variable DC" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudCheckBox @bind-Value="context.Item.VariableDutyCycle" Dense="true" />
            </EditTemplate>
        </PropertyColumn>
        <PropertyColumn Property="x => x.DutyCycleInput" Title="DC Input" CellStyle="max-width: 150px">
            <EditTemplate>
                <MudSelect T="VarMap" @bind-Value="context.Item.DutyCycleInput" Variant="Variant.Outlined" Dense="true">
                    @foreach (VarMap varMap in Enum.GetValues(typeof(VarMap)))
                    {
                        <MudSelectItem T="VarMap" Value="@varMap">@varMap</MudSelectItem>
                    }
                </MudSelect>
            </EditTemplate>
        </PropertyColumn>
        <TemplateColumn Title="Variable DC Denom" Resizable="true" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudNumericField @bind-Value="@context.Item.DutyCycleDenominator" 
                                 Min="0"
                                 Max="255"
                                 Step="1"/>
            </EditTemplate>
        </TemplateColumn>
        <PropertyColumn Property="x => x.SoftStartEnabled" Title="Soft Start" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudCheckBox @bind-Value="context.Item.SoftStartEnabled" Dense="true" />
            </EditTemplate>
        </PropertyColumn>
        <TemplateColumn Title="SS Duration (ms)" Resizable="true" CellStyle="max-width: 100px">
            <EditTemplate>
                <MudNumericField @bind-Value="@context.Item.SoftStartRampTime" 
                                 Min="0"
                                 Max="65535"
                                 Step="1"/>
            </EditTemplate>
        </TemplateColumn>
    </Columns>
</MudDataGrid>

@code {
    [Parameter, EditorRequired]
    public List<Output> Outputs { get; set; } = null!;
    
    private void OnDutyCycleChanged(Output item, int value)
    {
        if (value < 0 || value > 100)
        {
            //Snackbar.Add("Value must be between 0 and 100", Severity.Warning);
        }
        item.FixedDutyCycle = Math.Clamp(value, 0, 100);
        StateHasChanged(); // Force UI update to show clamped value
    }
}
